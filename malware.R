library(mlbench)
library(class)
library(randomForest)
library(ggplot2)

library(plyr)
library(rpart)
library(adabag)
library(corrplot)
library(FSelector)
library(nnet)


### data preparation ###

malware <- read.csv("malware.csv", header=TRUE, sep=";")
malware <- data.frame(malware)
malware <- na.omit(malware)
data<-malware
data <- as.matrix(sapply(data, as.numeric)) 
data <-data.frame (data)
data$Class = as.factor(data$Class)
x = as.matrix(data[,names(data) != "Class"])
mode(x) = "numeric"
data[,names(data) != "Class"] <-x

k= 10

### vectors for random forest  ###

accuracies_rf1 <- vector('numeric')
accuracies_rf2 <- vector('numeric')
accuracies_rf3 <- vector('numeric')
accuracies_rf4 <- vector('numeric')
accuracies_rf5 <- vector('numeric')
time_rf1 <- vector('numeric')
time_rf2 <- vector('numeric')
time_rf3 <- vector('numeric')
time_rf4 <- vector('numeric')
time_rf5 <- vector('numeric')

### vectors for boosting  ###

accuracies_boos1 <- vector('numeric')
accuracies_boos2 <- vector('numeric')
accuracies_boos3 <- vector('numeric')
accuracies_boos4 <- vector('numeric')
accuracies_boos5 <- vector('numeric')
time_boos1 <- vector('numeric')
time_boos2 <- vector('numeric')
time_boos3 <- vector('numeric')
time_boos4 <- vector('numeric')
time_boos5 <- vector('numeric')

### vectors for bagging ###

accuracies_bagg1 <- vector('numeric')
accuracies_bagg2 <- vector('numeric')
accuracies_bagg3 <- vector('numeric')
accuracies_bagg4 <- vector('numeric')
accuracies_bagg5 <- vector('numeric')
time_bagg1 <- vector('numeric')
time_bagg2 <- vector('numeric')
time_bagg3 <- vector('numeric')
time_bagg4 <- vector('numeric')
time_bagg5 <- vector('numeric')

data$id <- sample(1:k, nrow(data), replace = TRUE)
list <- 1:k

progress.bar <- create_progress_bar("text")
progress.bar$init(k)

for (i in 1:k)
{

  trainingset <- subset(data, id %in% list[-i])
  testset <- subset(data, id %in% c(i))
  
  ### random forest ###
  
  fold_time_rf1 <- as.numeric(system.time(rf1 <- randomForest(Class ~ ., data = trainingset, ntree = 5))[3])
  pred.rf1 <- predict(rf1,testset,type = "response")
  fold_accuracy_rf1 <- mean(pred.rf1 == testset$Class)
  accuracies_rf1 <- append(accuracies_rf1, fold_accuracy_rf1)
  time_rf1 <- append(time_rf1, fold_time_rf1)
  
  fold_time_rf2 <- as.numeric(system.time(rf2 <- randomForest(Class ~ ., data = trainingset, ntree = 25))[3])
  pred.rf2 <- predict(rf2,testset,type = "response")
  fold_accuracy_rf2 <- mean(pred.rf2 == testset$Class)
  accuracies_rf2 <- append(accuracies_rf2, fold_accuracy_rf2)
  time_rf2 <- append(time_rf2, fold_time_rf2)
  
  fold_time_rf3 <- as.numeric(system.time(rf3 <- randomForest(Class ~ ., data = trainingset, ntree = 50))[3])
  pred.rf3 <- predict(rf3,testset,type = "response")
  fold_accuracy_rf3 <- mean(pred.rf3 == testset$Class)
  accuracies_rf3 <- append(accuracies_rf3, fold_accuracy_rf3)
  time_rf3 <- append(time_rf3, fold_time_rf3)
  
  fold_time_rf4 <- as.numeric(system.time(rf4 <- randomForest(Class ~ ., data = trainingset, ntree = 75))[3])
  pred.rf4 <- predict(rf4,testset,type = "response")
  fold_accuracy_rf4 <- mean(pred.rf4 == testset$Class)
  accuracies_rf4 <- append(accuracies_rf4, fold_accuracy_rf4)
  time_rf4 <- append(time_rf4, fold_time_rf4)
  
  fold_time_rf5 <- as.numeric(system.time(rf5 <- randomForest(Class ~ ., data = trainingset, ntree = 100))[3])
  pred.rf5 <- predict(rf5,testset,type = "response")
  fold_accuracy_rf5 <- mean(pred.rf5 == testset$Class)
  accuracies_rf5 <- append(accuracies_rf5, fold_accuracy_rf5)
  time_rf5 <- append(time_rf5, fold_time_rf5)
 
  ### boosting ###
  
  fold_time_boos1 <- as.numeric(system.time(boos1 <- boosting(Class ~ ., data=trainingset, mfinal=5))[3])
  pred.boos1 <- predict.boosting(boos1,newdata = testset)
  fold_accuracy_boos1 <- (1 - pred.boos1$error)
  accuracies_boos1 <- append(accuracies_boos1, fold_accuracy_boos1)
  time_boos1 <- append(time_boos1, fold_time_boos1)
  
  fold_time_boos2 <- as.numeric(system.time(boos2 <- boosting(Class ~ ., data=trainingset, mfinal=25))[3])
  pred.boos2 <- predict.boosting(boos2,newdata = testset)
  fold_accuracy_boos2 <- (1 - pred.boos2$error)
  accuracies_boos2 <- append(accuracies_boos2, fold_accuracy_boos2)
  time_boos2 <- append(time_boos2, fold_time_boos2)
  
  fold_time_boos3 <- as.numeric(system.time(boos3 <- boosting(Class ~ ., data=trainingset, mfinal=50))[3])
  pred.boos3 <- predict.boosting(boos3,newdata = testset)
  fold_accuracy_boos3 <- (1 - pred.boos3$error)
  accuracies_boos3 <- append(accuracies_boos3, fold_accuracy_boos3)
  time_boos3 <- append(time_boos3, fold_time_boos3)
  
  fold_time_boos4 <- as.numeric(system.time(boos4 <- boosting(Class ~ ., data=trainingset, mfinal=75))[3])
  pred.boos4 <- predict.boosting(boos4,newdata = testset)
  fold_accuracy_boos4 <- (1 - pred.boos4$error)
  accuracies_boos4 <- append(accuracies_boos4, fold_accuracy_boos4)
  time_boos4 <- append(time_boos4, fold_time_boos4)
  
  fold_time_boos5 <- as.numeric(system.time(boos5 <- boosting(Class ~ ., data=trainingset, mfinal=100))[3])
  pred.boos5 <- predict.boosting(boos5,newdata = testset)
  fold_accuracy_boos5 <- (1 - pred.boos5$error)
  accuracies_boos5 <- append(accuracies_boos5, fold_accuracy_boos5)
  time_boos5 <- append(time_boos5, fold_time_boos5)
  
  ### bagging ###
  
  fold_time_bagg1 <- as.numeric(system.time(bagg1 <- bagging(Class ~ ., data=trainingset, mfinal=5))[3])
  pred.bagg1 <- predict.bagging(bagg1,newdata = testset)
  fold_accuracy_bagg1 <- (1 - pred.bagg1$error)
  accuracies_bagg1 <- append(accuracies_bagg1, fold_accuracy_bagg1)
  time_bagg1 <- append(time_bagg1, fold_time_bagg1)
  
  fold_time_bagg2 <- as.numeric(system.time(bagg2 <- bagging(Class ~ ., data=trainingset, mfinal=25))[3])
  pred.bagg2 <- predict.bagging(bagg2,newdata = testset)
  fold_accuracy_bagg2 <- (1 - pred.bagg2$error)
  accuracies_bagg2 <- append(accuracies_bagg2, fold_accuracy_bagg2)
  time_bagg2 <- append(time_bagg2, fold_time_bagg2)
  
  fold_time_bagg3 <- as.numeric(system.time(bagg3 <- bagging(Class ~ ., data=trainingset, mfinal=50))[3])
  pred.bagg3 <- predict.bagging(bagg3,newdata = testset)
  fold_accuracy_bagg3 <- (1 - pred.bagg3$error)
  accuracies_bagg3 <- append(accuracies_bagg3, fold_accuracy_bagg3)
  time_bagg3 <- append(time_bagg3, fold_time_bagg3)
  
  fold_time_bagg4 <- as.numeric(system.time(bagg4 <- bagging(Class ~ ., data=trainingset, mfinal=75))[3])
  pred.bagg4 <- predict.bagging(bagg4,newdata = testset)
  fold_accuracy_bagg4 <- (1 - pred.bagg4$error)
  accuracies_bagg4 <- append(accuracies_bagg4, fold_accuracy_bagg4)
  time_bagg4 <- append(time_bagg4, fold_time_bagg4)
  
  fold_time_bagg5 <- as.numeric(system.time(bagg5 <- bagging(Class ~ ., data=trainingset, mfinal=100))[3])
  pred.bagg5 <- predict.bagging(bagg5,newdata = testset)
  fold_accuracy_bagg5 <- (1 - pred.bagg5$error)
  accuracies_bagg5 <- append(accuracies_bagg5, fold_accuracy_bagg5)
  time_bagg5 <- append(time_bagg5, fold_time_bagg5)
 
  progress.bar$step()
}

### random forest final values ###

final_accuracy_rf1 <- mean(round((accuracies_rf1*100),1))
final_accuracy_rf1
final_time_rf1 <- mean(time_rf1)
final_time_rf1

final_accuracy_rf2 <- mean(round((accuracies_rf2*100),1))
final_accuracy_rf2
final_time_rf2 <- mean(time_rf2)
final_time_rf2

final_accuracy_rf3 <- mean(round((accuracies_rf3*100),1))
final_accuracy_rf3
final_time_rf3 <- mean(time_rf3)
final_time_rf3

final_accuracy_rf4 <- mean(round((accuracies_rf4*100),1))
final_accuracy_rf4
final_time_rf4 <- mean(time_rf4)
final_time_rf4

final_accuracy_rf5 <- mean(round((accuracies_rf5*100),1))
final_accuracy_rf5
final_time_rf5 <- mean(time_rf5)
final_time_rf5

matrix_accuracy_rf=c(final_accuracy_rf1, final_accuracy_rf2, final_accuracy_rf3, final_accuracy_rf4, final_accuracy_rf5)
matrix_time_rf=c(final_time_rf1, final_time_rf2, final_time_rf3, final_time_rf4, final_time_rf5)

matrix_accuracy_rf
matrix_time_rf

### boosting final values ###

final_accuracy_boos1 <- mean(round((accuracies_boos1*100),1))
final_accuracy_boos1
final_time_boos1 <- mean(time_boos1)
final_time_boos1

final_accuracy_boos2 <- mean(round((accuracies_boos2*100),1))
final_accuracy_boos2
final_time_boos2 <- mean(time_boos2)
final_time_boos2

final_accuracy_boos3 <- mean(round((accuracies_boos3*100),1))
final_accuracy_boos3
final_time_boos3 <- mean(time_boos3)
final_time_boos3

final_accuracy_boos4 <- mean(round((accuracies_boos4*100),1))
final_accuracy_boos4
final_time_boos4 <- mean(time_boos4)
final_time_boos4

final_accuracy_boos5 <- mean(round((accuracies_boos5*100),1))
final_accuracy_boos5
final_time_boos5 <- mean(time_boos5)
final_time_boos5

matrix_accuracy_boos=c(final_accuracy_boos1, final_accuracy_boos2, final_accuracy_boos3, final_accuracy_boos4, final_accuracy_boos5)
matrix_time_boos=c(final_time_boos1, final_time_boos2, final_time_boos3, final_time_boos4, final_time_boos5)

matrix_accuracy_boos
matrix_time_boos

### bagging final values ###

final_accuracy_bagg1 <- mean(round((accuracies_bagg1*100),1))
final_accuracy_bagg1
final_time_bagg1 <- mean(time_bagg1)
final_time_bagg1

final_accuracy_bagg2 <- mean(round((accuracies_bagg2*100),1))
final_accuracy_bagg2
final_time_bagg2 <- mean(time_bagg2)
final_time_bagg2

final_accuracy_bagg3 <- mean(round((accuracies_bagg3*100),1))
final_accuracy_bagg3
final_time_bagg3 <- mean(time_bagg3)
final_time_bagg3

final_accuracy_bagg4 <- mean(round((accuracies_bagg4*100),1))
final_accuracy_bagg4
final_time_bagg4 <- mean(time_bagg4)
final_time_bagg4

final_accuracy_bagg5 <- mean(round((accuracies_bagg5*100),1))
final_accuracy_bagg5
final_time_bagg5 <- mean(time_bagg5)
final_time_bagg5

matrix_accuracy_bagg=c(final_accuracy_bagg1, final_accuracy_bagg2, final_accuracy_bagg3, final_accuracy_bagg4, final_accuracy_bagg5)
matrix_time_bagg=c(final_time_bagg1, final_time_bagg2, final_time_bagg3, final_time_bagg4, final_time_bagg5)

matrix_accuracy_bagg
matrix_time_bagg

X11()
plot(matrix_accuracy_rf, col="blue", type="l", ylim=c(96,100), lwd=3, las=1, axes=FALSE, ann=FALSE)
lines(matrix_accuracy_boos, type="l", las=2, col="red", lwd=3)
lines(matrix_accuracy_bagg, type="l", las=3, col="green", lwd=3)

axis(1, at=1:5, lab=c("5", "25", "50", "75", "100"), cex.axis=1.3)
axis(2, at=96:100, cex.axis=1.3)
title(xlab="number of trees", cex.lab=1.3)
title(ylab="accuracy [%]", cex.lab=1.3)
title(main="Accuracy for malware detection", cex.main=1.6)

type <- c("Random forest", "Boosting", "Bagging")
legend("bottomleft",type, col=c("blue","red","green"), lty=1:3, lwd=3, cex=1.3)